<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation - {{PAGE_TITLE}}</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/style.css">
    <meta name="description" content="R√©servez votre table en ligne ou commandez vos plats pour emporter. R√©servation rapide et facile">
</head>
<body>
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <h1 id="business-name">Chargement...</h1>
                </div>
                <ul class="nav-menu" id="nav-menu">
                    <!-- Navigation g√©n√©r√©e dynamiquement -->
                </ul>
                <div class="nav-mobile">
                    <button class="nav-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="reservation-page">
        <!-- Header de la page r√©servation -->
        <section class="reservation-header">
            <div class="container">
                <h1>R√©servation & Commandes</h1>
                <p class="hero-subtitle">R√©servez votre table ou commandez vos plats pr√©f√©r√©s</p>
            </div>
        </section>

        <!-- Options de r√©servation -->
        <section class="reservation-options">
            <div class="container">
                <div class="options-grid">
                    <div class="option-card" id="table-reservation">
                        <div class="option-icon">üçΩÔ∏è</div>
                        <h3>R√©server une Table</h3>
                        <p>R√©servez votre table pour d√Æner sur place dans une ambiance conviviale</p>
                        <button class="btn-restaurant" onclick="showReservationForm()">
                            R√©server Maintenant
                        </button>
                    </div>
                    
                    <div class="option-card" id="takeaway-order">
                        <div class="option-icon">ü•°</div>
                        <h3>Commander √† Emporter</h3>
                        <p>Commandez vos plats pr√©f√©r√©s et venez les r√©cup√©rer au restaurant</p>
                        <button class="btn-restaurant" onclick="showOrderOptions()">
                            Commander
                        </button>
                    </div>
                    
                    <div class="option-card" id="phone-contact">
                        <div class="option-icon">üìû</div>
                        <h3>R√©servation T√©l√©phonique</h3>
                        <p>Appelez-nous directement pour une r√©servation personnalis√©e</p>
                        <a href="#" id="phone-link" class="btn-restaurant">
                            Appeler
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Formulaire de r√©servation de table -->
        <section class="reservation-form-section" id="reservation-form-section" style="display: none;">
            <div class="container">
                <div class="form-container">
                    <h2>R√©server une Table</h2>
                    
                    <form id="reservation-form" class="reservation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="res-name">Nom *</label>
                                <input type="text" id="res-name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="res-email">Email *</label>
                                <input type="email" id="res-email" name="email" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="res-phone">T√©l√©phone *</label>
                                <input type="tel" id="res-phone" name="phone" required>
                            </div>
                            <div class="form-group">
                                <label for="res-guests">Nombre de personnes *</label>
                                <select id="res-guests" name="guests" required>
                                    <option value="">Choisir</option>
                                    <option value="1">1 personne</option>
                                    <option value="2">2 personnes</option>
                                    <option value="3">3 personnes</option>
                                    <option value="4">4 personnes</option>
                                    <option value="5">5 personnes</option>
                                    <option value="6">6 personnes</option>
                                    <option value="7">7 personnes</option>
                                    <option value="8">8 personnes</option>
                                    <option value="more">Plus de 8 (nous contacter)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="res-date">Date *</label>
                                <input type="date" id="res-date" name="date" required min="">
                            </div>
                            <div class="form-group">
                                <label for="res-time">Heure souhait√©e *</label>
                                <select id="res-time" name="time" required>
                                    <option value="">Choisir l'heure</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="res-occasion">Occasion sp√©ciale</label>
                            <select id="res-occasion" name="occasion">
                                <option value="">Aucune occasion particuli√®re</option>
                                <option value="anniversary">Anniversaire</option>
                                <option value="birthday">F√™te d'anniversaire</option>
                                <option value="business">Repas d'affaires</option>
                                <option value="romantic">D√Æner romantique</option>
                                <option value="family">R√©union de famille</option>
                                <option value="celebration">C√©l√©bration</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="res-comments">Commentaires ou demandes sp√©ciales</label>
                            <textarea id="res-comments" name="comments" rows="3" placeholder="Allergies, pr√©f√©rences de table, etc."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="res-consent" required>
                                J'accepte que mes donn√©es soient utilis√©es pour traiter ma r√©servation
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="hideReservationForm()">
                                Annuler
                            </button>
                            <button type="submit" class="btn-restaurant" id="reservation-submit">
                                Confirmer la R√©servation
                            </button>
                        </div>
                    </form>

                    <div id="reservation-messages"></div>
                </div>
            </div>
        </section>

        <!-- Widget GloriaFood (si activ√©) -->
        <section class="widget-section" id="gloria-food-section" style="display: none;">
            <div class="container">
                <div class="widget-container">
                    <h2 class="widget-title">Commander en Ligne</h2>
                    <div class="widget-loading" id="gloria-food-loading">
                        Chargement du syst√®me de commande...
                    </div>
                    <div id="gloria-food-content" style="display: none;">
                        <!-- Le widget GloriaFood sera inject√© ici -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Informations utiles -->
        <section class="reservation-info">
            <div class="container">
                <h2>Informations Pratiques</h2>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-icon">‚è∞</div>
                        <h3>Horaires de Service</h3>
                        <div id="service-hours">
                            <div class="loading">Chargement des horaires...</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">üìã</div>
                        <h3>Politique de R√©servation</h3>
                        <ul>
                            <li>R√©servation recommand√©e, surtout le weekend</li>
                            <li>Confirmation par email ou t√©l√©phone</li>
                            <li>Modification possible jusqu'√† 2h avant</li>
                            <li>Table maintenue 15 minutes apr√®s l'heure</li>
                        </ul>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">üç∑</div>
                        <h3>Services Disponibles</h3>
                        <ul>
                            <li>Menu v√©g√©tarien et sans gluten</li>
                            <li>Adaptation pour allergies alimentaires</li>
                            <li>Groupes et √©v√©nements priv√©s</li>
                            <li>Vente √† emporter</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact d'urgence -->
        <section class="emergency-contact">
            <div class="container">
                <div class="emergency-card">
                    <h3>Besoin d'aide ?</h3>
                    <p>Pour toute question sur votre r√©servation ou pour des demandes sp√©ciales</p>
                    <div class="emergency-actions">
                        <a href="contact.html" class="btn-restaurant-outline">
                            Nous Contacter
                        </a>
                        <a href="#" id="emergency-phone" class="btn-restaurant">
                            Appeler Maintenant
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content" id="footer-content">
                <div class="loading">Chargement des informations...</div>
            </div>
            <div class="footer-bottom">
                <p>&copy; <span id="current-year"></span> <span id="footer-business-name"></span>. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Scripts personnalis√©s -->
    <script src="js/firebase-client.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/utils.js"></script>

    <script>
        const BUSINESS_ID = '{{BUSINESS_ID}}';
        const BUSINESS_TYPE = '{{BUSINESS_TYPE}}';
        const CURRENT_PAGE = 'reservation';
        
        class ReservationPageLoader {
            constructor() {
                this.businessData = null;
            }

            async initialize() {
                try {
                    // Charger les donn√©es business
                    this.businessData = await window.FirebaseClient.fetchBusinessData(BUSINESS_ID);
                    
                    // Initialiser la page
                    this.updatePageInfo();
                    this.loadNavigation();
                    this.setupContactLinks();
                    this.loadServiceHours();
                    this.setupDateTimeInputs();
                    this.loadFooter();
                    this.setupReservationForm();
                    this.checkGloriaFoodWidget();
                    
                } catch (error) {
                    console.error('Erreur lors de l\'initialisation:', error);
                    this.showErrorMessage();
                }
            }

            updatePageInfo() {
                const businessName = this.businessData.data.basic_info.name;
                if (businessName) {
                    document.title = `R√©servation - ${businessName}`;
                    document.getElementById('business-name').textContent = businessName;
                    document.getElementById('footer-business-name').textContent = businessName;
                }

                document.getElementById('current-year').textContent = new Date().getFullYear();
            }

            loadNavigation() {
                const navMenu = document.getElementById('nav-menu');
                const pages = [
                    { name: 'Accueil', url: 'index.html', active: false },
                    { name: 'Menu', url: 'menu.html', active: false },
                    { name: 'R√©server', url: 'reservation.html', active: true },
                    { name: 'Contact', url: 'contact.html', active: false }
                ];

                navMenu.innerHTML = pages.map(page => 
                    `<li><a href="${page.url}" class="${page.active ? 'active' : ''}">${page.name}</a></li>`
                ).join('');
            }

            setupContactLinks() {
                const basicInfo = this.businessData.data.basic_info;
                
                if (basicInfo.phone) {
                    document.getElementById('phone-link').href = `tel:${basicInfo.phone}`;
                    document.getElementById('emergency-phone').href = `tel:${basicInfo.phone}`;
                    document.getElementById('emergency-phone').style.display = 'inline-block';
                } else {
                    document.getElementById('phone-contact').style.display = 'none';
                    document.getElementById('emergency-phone').style.display = 'none';
                }
            }

            loadServiceHours() {
                const container = document.getElementById('service-hours');
                const hours = this.businessData.data.basic_info.hours;
                
                if (!this.hasOpeningHours(hours)) {
                    container.innerHTML = '<p>Horaires disponibles par t√©l√©phone</p>';
                    return;
                }

                const dayNames = {
                    monday: 'Lun', tuesday: 'Mar', wednesday: 'Mer',
                    thursday: 'Jeu', friday: 'Ven', saturday: 'Sam', sunday: 'Dim'
                };

                let hoursHTML = '<div class="hours-compact">';
                Object.entries(hours)
                    .filter(([day, time]) => time && time.trim())
                    .forEach(([day, time]) => {
                        hoursHTML += `<div class="hour-item">
                            <strong>${dayNames[day]}:</strong> ${time}
                        </div>`;
                    });
                hoursHTML += '</div>';

                container.innerHTML = hoursHTML;
            }

            hasOpeningHours(hours) {
                return hours && Object.values(hours).some(h => h && h.trim());
            }

            setupDateTimeInputs() {
                // D√©finir la date minimum (aujourd'hui)
                const today = new Date();
                const minDate = today.toISOString().split('T')[0];
                document.getElementById('res-date').setAttribute('min', minDate);
                
                // G√©n√©rer les cr√©neaux horaires
                this.generateTimeSlots();
                
                // √âcouter les changements de date pour adapter les horaires
                document.getElementById('res-date').addEventListener('change', () => {
                    this.updateAvailableTimeSlots();
                });
            }

            generateTimeSlots() {
                const timeSelect = document.getElementById('res-time');
                const slots = [];
                
                // Cr√©neaux de midi (12h-14h)
                for (let hour = 12; hour <= 14; hour++) {
                    for (let min of ['00', '30']) {
                        if (hour === 14 && min === '30') break;
                        slots.push(`${hour.toString().padStart(2, '0')}:${min}`);
                    }
                }
                
                // Cr√©neaux du soir (19h-21h30)
                for (let